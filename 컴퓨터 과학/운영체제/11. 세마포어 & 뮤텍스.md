# 세마포어 & 뮤텍스

## 세마포어(Semaphore) 와 뮤텍스(Mutex) 란
+ 여러 프로세스나 스레드가 공유 자원에 접근하면, 임계 영역(Critical Section)이 발생할 수 있기 때문에 이를 제어하기 위한 방법이다.
+ 즉, 병행 처리를 위한 **프로세스 동기화 기법**을 뜻한다.
+ 이러한 동기화 기법에는 **세마포어**와 **뮤텍스**가 존재한다.

### 임계 영역(Critical Section)
+ 프로그램에서 공유 자원을 사용하는 코드 블럭을 의미한다.
+ 여러 프로세스가 동일 자원을 사용할 때, 이를 동시에 참조하는 경우 값이 오염될 위험이 있다.
+ 그러므로 프로그래밍 시, 성능 향상을 위해 이러한 임계 영역을 최소화하는 설계를 할 필요성이 있다. 

<br>

## 뮤텍스(Mutext)

<br>

![image](https://user-images.githubusercontent.com/49611158/147403137-0a24a4ce-9e3d-4dea-9e2c-21da0833ff7f.png)

<br>

+ 동시 프로그래밍에서 공유 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘
+ 임계 영역을 가진 스레드들의 실행시간이 서로 곂치지 않고 **단독으로 실행(상호 배제, Mutual Exclution)**되도록 하는 기술
+ 한 프로세스에 의해 소유될 수 있는 Key를 기반으로 한 상호배제 기법
    - Key에 해당하는 어떤 객체가 있으며, 이 객체를 소유한 스레드/프로세스 만이 공유 자원에 접근할 수 있다.
+ 다중 프로세스들의 공유 리소스에 대한 접근 조율을 위한 **동기화(Synchronization)** 또는 **락(Lock)**을 사용
    - Lock : 현재 임계 영역에 들어갈 권한을 받아옴
        + 다른 프로세스/스레드가 임계 영역 수행 중이면 종료 시 까지 대기
    - Unlock : 현재 임계 영역을 모두 사용했음을 알림
        + 대기 중인 다른 프로세스/스레드가 임계 영역에 진입할 수 있음.

### 뮤텍스 알고리즘
1. 데커(Dekker) 알고리즘
    + flag 와 turn 변수를 통해 임계 영역에 들어갈 프로세스/스레드를 결정
        - flag : 프로세스 중 누가 임계 영역에 진입할 것인지를 나타내는 배열 변수
        - turn : 누가 임계 영역에 들어갈 차례인지를 나타내는 변수

```javascript
while(true) {
    flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
    while(flag[j]) { // 프로세스 j가 현재 임계 구역에 있는지 확인
        if(turn == j) { // j가 임계 구역 사용 중이면
            flag[i] = false; // 프로세스 i 진입 취소
            while(turn == j); // turn이 j에서 변경될 때까지 대기
            flag[i] = true; // j turn이 끝나면 다시 진입 시도
        }
    }
}

// ------- 임계 구역 ---------

turn = j; // 임계 구역 사용 끝나면 turn을 넘김
flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림
```

2. 피터슨(Peterson) 알고리즘
    + 데커와 유사하지만, 상대방 프로세스/스레드에게 진입 기회를 양보하는 것에 차이가 있음

```javascript
while(true) {
    flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
    turn = j; // 다른 프로세스에게 진입 기회 양보
    while(flag[j] && turn == j) { // 다른 프로세스가 진입 시도하면 대기
    }
}

// ------- 임계 구역 ---------

flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림
```

3. 제과점(Bakery) 알고리즘
    + 여러 프로세스/스레드에 대한 처리가 가능한 알고리즘
    + 가장 작은 수의 번호표를 가지고 있는 프로세스가 임계 구역에 진입한다.

```javascript
while(true) {
    
    isReady[i] = true; // 번호표 받을 준비
    number[i] = max(number[0~n-1]) + 1; // 현재 실행 중인 프로세스 중에 가장 큰 번호 배정 
    isReady[i] = false; // 번호표 수령 완료
    
    for(j = 0; j < n; j++) { // 모든 프로세스 번호표 비교
        while(isReady[j]); // 비교 프로세스가 번호표 받을 때까지 대기
        while(number[j] && number[j] < number[i] && j < i);
        
        // 프로세스 j가 번호표 가지고 있어야 함
        // 프로세스 j의 번호표 < 프로세스 i의 번호표
    }
}

// ------- 임계 구역 ---------

number[i] = 0; // 임계 구역 사용 종료
```
<br>

## 세마포어(Semaphore)

<br>

![image](https://user-images.githubusercontent.com/49611158/147403354-895d33bd-ebf7-43a5-a703-5440b3fd1cea.png)

<br>

+ 멀티 프로그래밍 환경에서 공유된 자원에 대한 접근을 제한하는 방법
+ 공유자원에 접근할 수 있는 프로세스의 최대 허용치만큼 동시에 사용자가 접근할 수 있음
+ wait 과 signal을 통해 구현된다.
    -  wait이 먼저 호출되어 임계영역에 들어갈 수 있는지 확인
    - 혹은 먼저 실행되어야 하는 프로세스가 실행되는지 확인
    - 조건에 만족하면 wait을 빠져나와 임계영역으로 들어간다.
    - 이후 signal이 호출되어 임계영역에서 빠져나왔음을 알린다.
+ 자원을 사용하지 않는 상태가 될 때, 대기하던 프로세스가 즉시 자원을 사용한다
+ 이미 다른 프로세스에 의해 사용중이라는 사실을 알게 되면, 재시도 전에 일정시간 대기해야 한다.
+ 세마포어를 사용하는 프로세스는 그 값을 확인하고, 자원을 사용하는 동안에는 그 값을 변경함으로써 다른 세마포어 사용자들이 대기하도록 해야 함
+ 세마포어는 이진수를 사용하거나 추가적인 값을 가질 수 있다.


<br>

## 뮤텍스와 세마포어의 차이점
1. 동기화 대상의 개수
    + Mutex는 동기화 대상이 오직 1개일 때 사용
    + Semaphore는 동기화 대상이 1개 이상일 때 사용
2. Semaphore는 Mutext가 될 수 있지만, Mutex는 Semaphore가 될 수 없음
    + Mutex는 0, 1로 이루어진 이진 상태를 가지므로 Binary Semaphore 라고도 부른다.
3. Mutex는 자원 소유 가능 + 책임을 가지지만, Semaphore는 자원 소유 불가
    + Mutex는 상태 0, 1 뿐이므로 Lock을 가질 수 있음
4. Mutex는 소유하고 있는 스레드만이 Mutex를 해제할 수 있음
    + 반면 Semaphore는 Semaphore를 소유하지 않은 스레드가 Semaphore를 해제할 수 있음
5. Semaphore는 시스템 범위에 걸쳐 있고, 파일 시스템 상의 파일로 존재함
    + 반면 Mutex는 프로세스의 범위를 가지며 프로세스를 종료할 때 자동으로 Clean up 된다.

<br>

## 참조
+ [그림으로 보는 세마포어와 뮤텍스](https://worthpreading.tistory.com/90)